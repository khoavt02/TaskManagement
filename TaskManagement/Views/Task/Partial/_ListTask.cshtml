@using System.Data;
@model List<TaskManagement.Models.TaskView>;
<div class="row" id="list-task-kaban">
    <div class="col-12 col-lg-6 col-xl-3">
        <div class="card">
            <div class="card-header" style="padding-bottom: 0 !important;">
                <div class="card-actions float-right">
                    <div class="dropdown show">
                        <a href="#" data-toggle="dropdown" data-display="static">
                            <i class="align-middle" data-feather="more-horizontal"></i>
                        </a>

                        <div class="dropdown-menu dropdown-menu-right">
                            <a class="dropdown-item" href="#">Action</a>
                            <a class="dropdown-item" href="#">Another action</a>
                            <a class="dropdown-item" href="#">Something else here</a>
                        </div>
                    </div>
                </div>
                <div class="badge badge-warning my-2" style="font-size:15px;">Đang chờ</div>
            </div>

            <div class="card-body p-3">
                <div id="tasks-upcoming" style="min-height: 50px !important;">
                    @if (Model != null)
                    {
                        foreach (var item in Model)
                        {
                            if (item.Status == "NEW")
                            {
                                <div class="card mb-3 bg-light cursor-grab border draggable-item" data-item-id="@item.Id">
                                    <div class="card-body p-3">
                                        <div class="float-right mr-n2">
                                            @switch (item.Level)
                                            {
                                                case "IMPORTANT":
                                                    <div class="badge badge-danger">Quan trọng</div>
                                                    break;
                                                case "HIGH":
                                                    <div class="badge badge-warning">Cao</div>
                                                    break;
                                                case "NORMAL":
                                                    <div class="badge badge-info">Bình thường</div>
                                                    break;
                                                case "LOW":
                                                    <div class="badge badge-primary">Thấp</div>
                                                    break;
                                                default:
                                                    <div class="unknown-level"></div>
                                                    break;
                                            }
                                        </div>
                                        <p>@item.TaskName</p>
                                        <div class="float-right mt-n1">
                                            <span>@item.EstimateTime (h)</span>
                                        </div>
                                        <a class="btn btn-primary btn-sm" href="/Task/TaskDetail?id=@item.Id">Chi tiết</a>
                                    </div>
                                    <ul class="list-group list-group-flush">
                                        <li class="list-group-item px-4 pb-4">
                                            <p class="mb-2 font-weight-bold">Tiến độ <span class="float-right">@item.ProcessPercent%</span></p>
                                            <div class="progress progress-sm">
                                                <div class="progress-bar" role="progressbar" aria-valuenow="@item.ProcessPercent" aria-valuemin="0" aria-valuemax="100" style="width: @item.ProcessPercent%;">
                                                </div>
                                            </div>
                                        </li>
                                    </ul>
                                </div>
                            }
                        }
                    }
                </div>
            </div>
        </div>
    </div>
    <div class="col-12 col-lg-6 col-xl-3">
        <div class="card">
            <div class="card-header" style="padding-bottom: 0 !important;">
                <div class="card-actions float-right">
                    <div class="dropdown show">
                        <a href="#" data-toggle="dropdown" data-display="static">
                            <i class="align-middle" data-feather="more-horizontal"></i>
                        </a>

                        <div class="dropdown-menu dropdown-menu-right">
                            <a class="dropdown-item" href="#">Action</a>
                            <a class="dropdown-item" href="#">Another action</a>
                            <a class="dropdown-item" href="#">Something else here</a>
                        </div>
                    </div>
                </div>
                <div class="badge badge-info my-2" style="font-size:15px;">Đang thực hiện</div>
            </div>
            <div class="card-body">

                <div id="tasks-progress" style="min-height: 50px !important;">
                    @if (Model != null)
                    {
                        foreach (var item in Model)
                        {
                            if (item.Status == "PROCESSING")
                            {
                                <div class="card mb-3 bg-light cursor-grab border draggable-item" data-item-id="@item.Id">
                                    <div class="card-body p-3">
                                        <div class="float-right mr-n2">
                                            @switch (item.Level)
                                            {
                                                case "IMPORTANT":
                                                    <div class="badge badge-danger">Quan trọng</div>
                                                    break;
                                                case "HIGH":
                                                    <div class="badge badge-warning">Cao</div>
                                                    break;
                                                case "NORMAL":
                                                    <div class="badge badge-info">Bình thường</div>
                                                    break;
                                                case "LOW":
                                                    <div class="badge badge-primary">Thấp</div>
                                                    break;
                                                default:
                                                    <div class="unknown-level"></div>
                                                    break;
                                            }
                                        </div>
                                        <p>@item.TaskName</p>
                                        <div class="float-right mt-n1">
                                            <span>@item.EstimateTime (h)</span>
                                        </div>
                                        <a class="btn btn-primary btn-sm" href="/Task/TaskDetail?id=@item.Id">Chi tiết</a>
                                    </div>
                                    <ul class="list-group list-group-flush">
                                        <li class="list-group-item px-4 pb-4">
                                            <p class="mb-2 font-weight-bold">Tiến độ <span class="float-right">@item.ProcessPercent%</span></p>
                                            <div class="progress progress-sm">
                                                <div class="progress-bar" role="progressbar" aria-valuenow="@item.ProcessPercent" aria-valuemin="0" aria-valuemax="100" style="width: @item.ProcessPercent%;">
                                                </div>
                                            </div>
                                        </li>
                                    </ul>
                                </div>
                            }
                        }
                    }
                </div>


            </div>
        </div>
    </div>
    <div class="col-12 col-lg-6 col-xl-3">
        <div class="card">
            <div class="card-header" style="padding-bottom: 0 !important;">
                <div class="card-actions float-right">
                    <div class="dropdown show">
                        <a href="#" data-toggle="dropdown" data-display="static">
                            <i class="align-middle" data-feather="more-horizontal"></i>
                        </a>

                        <div class="dropdown-menu dropdown-menu-right">
                            <a class="dropdown-item" href="#">Action</a>
                            <a class="dropdown-item" href="#">Another action</a>
                            <a class="dropdown-item" href="#">Something else here</a>
                        </div>
                    </div>
                </div>
                <div class="badge badge-success my-2" style="font-size:15px;">Hoàn thành</div>

            </div>
            <div class="card-body">

                <div id="tasks-hold" style="min-height: 50px !important;">
                    @if (Model != null)
                    {
                        foreach (var item in Model)
                        {
                            if (item.Status == "COMPLETE")
                            {
                                <div class="card mb-3 bg-light cursor-grab border draggable-item" data-item-id="@item.Id">
                                    <div class="card-body p-3">
                                        <div class="float-right mr-n2">
                                            @switch (item.Level)
                                            {
                                                case "IMPORTANT":
                                                    <div class="badge badge-danger">Quan trọng</div>
                                                    break;
                                                case "HIGH":
                                                    <div class="badge badge-warning">Cao</div>
                                                    break;
                                                case "NORMAL":
                                                    <div class="badge badge-info">Bình thường</div>
                                                    break;
                                                case "LOW":
                                                    <div class="badge badge-primary">Thấp</div>
                                                    break;
                                                default:
                                                    <div class="unknown-level"></div>
                                                    break;
                                            }
                                        </div>
                                        <p>@item.TaskName</p>
                                        <div class="float-right mt-n1">
                                            <span>@item.EstimateTime (h)</span>
                                        </div>
                                        <a class="btn btn-primary btn-sm" href="/Task/TaskDetail?id=@item.Id">Chi tiết</a>
                                    </div>
                                    <ul class="list-group list-group-flush">
                                        <li class="list-group-item px-4 pb-4">
                                            <p class="mb-2 font-weight-bold">Tiến độ <span class="float-right">@item.ProcessPercent%</span></p>
                                            <div class="progress progress-sm">
                                                <div class="progress-bar" role="progressbar" aria-valuenow="@item.ProcessPercent" aria-valuemin="0" aria-valuemax="100" style="width: @item.ProcessPercent%;">
                                                </div>
                                            </div>
                                        </li>
                                    </ul>
                                </div>
                            }
                        }
                    }
                </div>

            </div>
        </div>
    </div>
    <div class="col-12 col-lg-6 col-xl-3">
        <div class="card">
            <div class="card-header" style="padding-bottom: 0 !important;">
                <div class="card-actions float-right">
                    <div class="dropdown show">
                        <a href="#" data-toggle="dropdown" data-display="static">
                            <i class="align-middle" data-feather="more-horizontal"></i>
                        </a>

                        <div class="dropdown-menu dropdown-menu-right">
                            <a class="dropdown-item" href="#">Action</a>
                            <a class="dropdown-item" href="#">Another action</a>
                            <a class="dropdown-item" href="#">Something else here</a>
                        </div>
                    </div>
                </div>
                <div class="badge badge-secondary my-2" style="font-size:15px;">Đã đánh giá</div>

            </div>
            <div class="card-body">

                <div id="tasks-completed" style="min-height: 50px !important;">
                    @if (Model != null)
                    {
                        foreach (var item in Model)
                        {
                            if (item.Status == "EVALUATE")
                            {
                                <div class="card mb-3 bg-light cursor-grab border draggable-item" data-item-id="@item.Id">
                                    <div class="card-body p-3">
                                        <div class="float-right mr-n2">
                                            @switch (item.Level)
                                            {
                                                case "IMPORTANT":
                                                    <div class="badge badge-danger">Quan trọng</div>
                                                    break;
                                                case "HIGH":
                                                    <div class="badge badge-warning">Cao</div>
                                                    break;
                                                case "NORMAL":
                                                    <div class="badge badge-info">Bình thường</div>
                                                    break;
                                                case "LOW":
                                                    <div class="badge badge-primary">Thấp</div>
                                                    break;
                                                default:
                                                    <div class="unknown-level"></div>
                                                    break;
                                            }
                                        </div>
                                        <p>@item.TaskName</p>
                                        <div class="float-right mt-n1">
                                            <span>@item.EstimateTime (h)</span>
                                        </div>
                                        <a class="btn btn-primary btn-sm" href="/Task/TaskDetail?id=@item.Id">Chi tiết</a>
                                    </div>
                                    <ul class="list-group list-group-flush">
                                        <li class="list-group-item px-4 pb-4">
                                            <p class="mb-2 font-weight-bold">Tiến độ <span class="float-right">@item.ProcessPercent%</span></p>
                                            <div class="progress progress-sm">
                                                <div class="progress-bar" role="progressbar" aria-valuenow="@item.ProcessPercent" aria-valuemin="0" aria-valuemax="100" style="width: @item.ProcessPercent%;">
                                                </div>
                                            </div>
                                        </li>
                                    </ul>
                                </div>
                            }
                        }
                    }
                </div>


            </div>
        </div>
    </div>
</div>
<script>
    $(function () {
        var drake = dragula([
            document.querySelector("#tasks-upcoming"),
            document.querySelector("#tasks-progress"),
            document.querySelector("#tasks-hold"),
            document.querySelector("#tasks-completed")
        ]);

        drake.on('drop', function (el, target, source, sibling) {
            // Lấy thông tin cần thiết từ phần tử và các container
            var itemId = el.dataset.itemId;
            var sourceColumnId = source.id;
            var targetColumnId = target.id;
            console.log(itemId, sourceColumnId, targetColumnId)
            if ((sourceColumnId == "tasks-hold" && targetColumnId == "tasks-completed") || (targetColumnId == "tasks-completed")) {
                toastr["error"]('Không thể thay đổi trạng thái công việc này', 'Thông báo', {
                    positionClass: 'toast-top-right',
                    closeButton: true,
                    progressBar: true,
                    newestOnTop: true,
                });
                drake.cancel(true);
                return;
            }
            var status;
            switch (targetColumnId) {
                case 'tasks-upcoming':
                    status = 'NEW';
                    break;
                case 'tasks-progress':
                    status = 'PROCESSING';
                    break;
                case 'tasks-hold':
                    status = 'COMPLETE';
                    break;
                case 'tasks-completed':
                    status = 'EVALUATE';
                    break;
                default:
                    status = 'UNKNOWN';
                    break;
            }
            var formData = new FormData();
            formData.append("id", itemId);
            formData.append("status", status);
            $.ajax({
                type: 'POST',
                url: "/Task/UpdateTaskStatus",
                contentType: false,
                processData: false,
                cache: false,
                data: formData,
                success: function (rp) {
                    if (rp.status == true) {
                        console.log(rp.message)
                        var message = rp.message;
                        var title = "";
                        toastr["success"](message, title, {
                            positionClass: 'toast-top-right',
                            closeButton: true,
                            progressBar: true,
                            newestOnTop: true,
                        });
                        //uploadFile();
                        // js_GetList();
                        //window.location.reload();
                    } else {
                        var message = rp.message;
                        var title = "";
                        toastr["error"](message, title, {
                            positionClass: 'toast-top-right',
                            closeButton: true,
                            progressBar: true,
                            newestOnTop: true,
                        });
                    }
                }
            })
        });
    })
</script>